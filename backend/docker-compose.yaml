version: '3'


services:
  
  redis:
    image: redis:6-alpine
    container_name: portfolio-redis

  postgres:
    image: postgres:13.0-alpine
    container_name: portfolio-postgres
    restart: always
    volumes:
      - postgres_data:/var/lib/postgresql/data/
    environment:
      - POSTGRES_USER=${DB_USER}
      - POSTGRES_DB=${DB_NAME}
      - POSTGRES_PASSWORD=${DB_PASSWORD}
      - POSTGRES_HOST=${DB_HOST}
      - POSTGRES_PORT=${DB_PORT}
  
  django: &django
    build: ./portfolio
    container_name: portfolio-django
    env_file:
      - .env
    command: [python, manage.py, runserver, 0.0.0.0:8000]
    volumes:
      - ./portfolio:/usr/src/portfolio
      - ./.credentials:/.credentials
    ports:
      - 8000:8000
    environment:
      - DJANGO_DEBUG=1
    secrets:
      - google_client_secret
    depends_on: 
      - redis
      - postgres

  celery:
    <<: *django
    container_name: portfolio-celery
    command: [
      celery, -A, portfolio,
      worker, --loglevel=info, --logfile=logs/celery.log
    ]
    ports: []
    depends_on:
      - django
        
  flower:
    <<: *django
    container_name: portfolio-flower
    command: [
      celery, -A, portfolio,
      "--broker=${CELERY_BROKER}",
      flower, --port=5555
    ]
    ports:
      - 5555:5555
    depends_on:
      - celery
  
  
volumes:
  postgres_data:
    
    
secrets:
  google_client_secret:
    file: ./google_client.secret